<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>Encontrei um Animal</title>
</head>

<body>
  
  <header>
    <div class="home">
      <a href="./index.html">
        <img src="../imagens/patinhaLogo.png" alt="logo" class="logo">
      </a>
    </div>
    <nav>
      <a href="./doacao.html">Doar</a>
      <a href="./encontreiAnimal.html">Encontrei um Animal</a>
      <a href="./sobreONG.html">Sobre a ONG</a>
      <a href="./perfil.html">
        <img src="../imagens/user_icon.png" alt="user-icon" class="logo">
      </a>
    </nav>
  </header>

  <main>
    <img src="../imagens/gatocarregando-unscreen.gif" alt="Carregando" id="GV_imagemdesitecarregando" class="GV_sitecarregando GV_esconder">
    <div class="container GV_containerformularioprincipal">
      <div class="row div-titulo GV_tituloformulario">
        <h3 class="titulo">Preenchas as informações e envie para ONG</h3>
      </div>

      <div class="row fill_green GV_divformformulario">
        <!--<h1 id="questionario">Questionário</h1>-->
        <h1 id="questionario2"></h1>
        <div class="row">
          <div id="LCmsg" class="col-sm-10 offset-sm-1 ">
              <!--Mensagem de erro-->
          </div>
        </div>
        <form id="questionForm" enctype="multipart/form-data">
          <div class="form-group row align-items-center">
            <div class="col-lg-6 col-xs-12">
              <div class="form-group row align-items-center mb-3">
                <label for="inputNome" class="HG_label_box col-sm-2">Nome:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputNome" required placeholder="Informe seu nome" name="name" disabled>
                </div>
              </div>

              <div class="form-group row align-items-center mb-3">
                <label for="inputEmail" class="HG_label_box col-sm-2">Email:</label>
                <div class="col GV_inputsformulario">
                  <input type="email" class="form-control" id="inputEmail" required placeholder="Informe seu email" name="email" disabled>
                </div>
              </div>

              
              <div class="form-group row align-items-center mb-3">
                <label for="inputTelefone" class="HG_label_box col-sm-2">Telefone:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputTelefone" required placeholder="Informe seu telefone" name="telefone" disabled>
                </div>
              </div>
            </div>
            
            <div class="col-lg-6 col-xs-12">
              <div class="form-group row align-items-center mb-3">
                <label for="inputNomeAnimal" class="HG_label_box col-sm-3">Nome do animal:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputNomeAnimal" required placeholder="Informe o nome do animal" name="nome-animal">
                </div>
              </div>
              
              <div class="form-group row align-items-center mb-3">
                <label for="inputEndereco" class="HG_label_box col-sm-2">Endereço:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputEndereco" required placeholder="Informe o último endereço do animal" name="endereco_do_animal">
                </div>
              </div>

              <div class="form-group row align-items-center mb-3">
                <label for="inputEspecie" class="HG_label_box col-sm-2">Espécie:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputEspecie" required placeholder="Cachorro, gato..." name="especie" disabled>
                </div>
              </div>

              <div class="form-group row align-items-center mb-3">
                <label for="inputRaca" class="HG_label_box col-sm-2">Raça:</label>
                <div class="col GV_inputsformulario">
                  <input type="text" class="form-control" id="inputRaca" required placeholder="Vira-lata, pinscher..." name="raça" disabled>
                </div>
              </div>


            </div>

  
            
              <div class="form-group row align-items-center mb-3 GV_divmensagemencontreianimal">
                <label for="inputMensagem" class="HG_label_box col-12">Mensagem:</label>
                <div class="col GV_inputsformulario">
                  <textarea name="message" id="inputMensagem" placeholder="Fale sobre o animal" required></textarea>
                </div>
              </div>

              <div class="form-group row align-items-center mb-3">
                <label for="inputArquivo" class="HG_label_box col-sm-2">Imagem:</label>
                <div class="col GV_inputsformulario">
                  <input type="file" name="attachment" id="inputArquivo" required placeholder="Anexe a imagem" class="form-control" accept="image/png, image/jpeg">
                </div>
              </div>
            </div>
            
            <!-- Div onde a imagem será exibida -->
            <div class="form-group row align-items-center mb-3 justify-content-center">
              <!-- Label para a imagem -->
              <label for="previewImage" class="HG_label_box col-sm-2 text-center">Prévia da Imagem:</label>
              <div class="form-group row align-items-center mb-3 justify-content-center">
              <!-- Imagem de prévia -->
              <div class="col-sm-6 col-md-4 GV_inputsformulario d-flex justify-content-center align-items-center">
                  <img id="previewImage" src="" alt="Imagem prévia" class="img-fluid" style="max-width: 400px; max-height: 400px; display: none;">
              </div>
            </div>
            </div>
          <div class="form-group row align-items-center">
            <div class="col-sm-12 text-center"><h1></h1></div>
            <div class="col-sm-12 text-center">
              <button type="submit" class="btn btn-success" id="btnInsert">Enviar</button>
              <input type="button" class="btn btn-secondary" id="btnClear" value="Limpar">
            </div>
            
          </div>
        </form>
      </div>
    </div>
  </main>

  <footer class="footer-estilizadoJP">
    <div>
      <p>&copy; <span id="dataJP"></span> Patinhas Felizes</p>
      <p>Conexão entre ONGs e Adotantes!</p>
    </div>
  </footer>
  
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
   <script src="../script-bd/script.js"></script>
    <script>
      $(document).ready(function () {
            init();
        });

        async function init() {
          const GV_formulario_email = document.getElementById("questionForm");

          if(!LCverificarLogin()){
            window.location.href = "./login.html";
          }
          let obj_usuario_atual = LCgetUser();
          console.log(obj_usuario_atual);
          $("#inputEmail").val(obj_usuario_atual.email);
          $("#inputTelefone").val(obj_usuario_atual.telefone);
          $("#inputNome").val(obj_usuario_atual.nome);

          //$("#inputEndereco").val("aaaaaaaaaaaaa");
          //$("#inputNomeAnimal").val("aaaaaaaaaaaaaaaaaa");
          //$("#inputMensagem").val("aaaaaaaaaaaaaaaaaaaaaaaa");

          async function reconheceranimal(e) {
            const image = document.getElementById('previewImage');
            image.src = e.target.result;  // Define a imagem
            image.style.display = 'block'; // Torna a imagem visível
            
            var base64Image = e.target.result.replace(/^data:image\/[a-zA-Z]+;base64,/, "");

            //Transformar a imagem serializada na base 64 em objeto java script
            let obj_imagem64 = {
              imagem: base64Image
            }

            // Exibe a imagem na div com o id 'previewImage'
            console.log('Imagem como base64:', e.target.result); // Isso vai exibir a imagem em formato base64
            console.log('Imagem como base64:', base64Image); // Isso vai exibir a imagem em formato base64
            let obj_reconhecimento = await HG_sendAnimal(obj_imagem64);

            console.log('Animal reconhecido:', obj_reconhecimento);
            $("#inputEspecie").val(obj_reconhecimento.especie);
            $("#inputRaca").val(obj_reconhecimento.raca);
          };

            document.getElementById('inputArquivo').addEventListener('change', async function(event) {
              let imagemcarregando = document.getElementById("GV_imagemdesitecarregando");
              try{
                imagemcarregando.classList.remove("GV_esconder");
                const file = event.target.files[0]; // Obtém o primeiro arquivo selecionado
                console.log('Chegou aqui');

                if (file) {
                  console.log('Arquivo selecionado:');
                  console.log('Nome:', file.name);
                  console.log('Tipo:', file.type);
                  console.log('Tamanho:', file.size, 'bytes');

                  
                  // Criar uma promessa que resolverá quando o `FileReader` terminar 
                  await new Promise(
                    (resolve, reject) => { 
                      const reader = new FileReader();
                      reader.onload = (e) => { 
                        reconheceranimal(e).then(resolve).catch(reject);
                      };
                      reader.onerror = reject;
                      reader.readAsDataURL(file);
                    });
                } else {
                  throw new Error("Erro! Nenhum arquivo foi selecionado!");
                }
                imagemcarregando.classList.add("GV_esconder");
              }catch(error){
                console.error(error.stack);
                imagemcarregando.classList.add("GV_esconder");
                LCdisplayMessage("Erro!");
              }
            });
            

            GV_formulario_email.addEventListener("submit", async (event) => {
              event.preventDefault();
              let imagemcarregando = document.getElementById("GV_imagemdesitecarregando");
              try{
                let especie = $("#inputEspecie").val();
                let raca = $("#inputRaca").val();
                if(especie == "" || raca == ""){
                  throw new Error("Aguarde o reconhecimento do animal!");
                }
                imagemcarregando.classList.remove("GV_esconder");
                let inputarquivoimagem = document.getElementById("inputArquivo");

                let arquivoimagem = inputarquivoimagem.files[0]

                if(!arquivoimagem){
                  throw new Error("Erro!");
                }

                console.log(arquivoimagem.name);
                console.log(arquivoimagem.type);
                console.log(arquivoimagem.size)
                
                let imagembase64 = "";
                
                await new Promise((resolve, reject) => { 
                  const reader = new FileReader();
                  reader.readAsDataURL(arquivoimagem);
                  reader.onload = (e) => { 
                    imagembase64 = e.target.result.split(',')[1];
                    resolve();
                  };
                  
                  reader.onerror = reject;
                });

                // Captura os dados dos campos do formulário
                let nome = $("#inputNome").val();
                let email = $("#inputEmail").val();
                let endereco = $("#inputEndereco").val();
                let telefone = $("#inputTelefone").val();
                let nomeAnimal = $("#inputNomeAnimal").val();
                
                
                let mensagem = $("#inputMensagem").val();
                let usuarioid = LCgetUser().id;

                let obj_email = {
                  mensagem: mensagem,
                  nomeusuario: nome,
                  usuarioid: usuarioid,
                  telefone: telefone,
                  email: email,
                  nomeanimal: nomeAnimal,
                  especie: especie,
                  raca: raca,
                  endereco: endereco,
                  imgserial: imagembase64,
                }

                await GV_enviaremail(obj_email);

                LCdisplayMessage("Sucesso ao enviar email!")
                imagemcarregando.classList.add("GV_esconder");
                location.href = "./index.html"
              }catch(e){
                if(e.message == "Aguarde o reconhecimento do animal!"){
                  LCdisplayMessage("Aguarde o reconhecimento do animal!");
                } else {
                  imagemcarregando.classList.add("GV_esconder");
                  console.error(e.stack);
                  LCdisplayMessage("Erro! Nao foi possivel enviar email!")
                }
              }

            })
            

            
            }
    </script>
</body>

</html>